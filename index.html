<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ç¾è‚¡æ“ç›˜è´¦æœ¬</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2422/2422796.png" />

  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

  <style>
    :root { --p:#007AFF; --s:#34C759; --d:#FF3B30; --bg:#F2F2F7; }
    body { font-family:-apple-system, sans-serif; background:var(--bg); margin:0; padding-bottom:120px; -webkit-user-select:none; }

    header { background:#fff; padding:20px 18px; border-bottom:1px solid #ddd; position:sticky; top:0; z-index:10; }
    .header-grid { display:flex; gap:14px; justify-content:space-between; align-items:flex-end; }
    .stat-label { font-size:12px; color:#888; margin-bottom:5px; }
    .stat-val { font-size:20px; font-weight:800; line-height:1.1; }
    .win { color:var(--s); }
    .loss { color:var(--d); }
    .muted { color:#444; }

    main { padding:15px; }
    .card { background:#fff; border-radius:15px; padding:16px; margin-bottom:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); border-left:6px solid #ccc; }
    .card.buy { border-left-color:var(--p); }
    .card.sell { border-left-color:#FF9500; }
    .card-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:10px; }
    .symbol { font-size:18px; font-weight:900; }
    .time { font-size:12px; color:#999; text-align:right; }
    .pnl-box { margin-top:10px; padding-top:10px; border-top:1px dashed #eee; text-align:right; }
    .subtle { font-size:12px; color:#999; }

    .bottom-nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; gap:18px; z-index:100; }
    .btn-round { width:65px; height:65px; border-radius:50%; border:none; color:#fff; font-size:24px; box-shadow:0 4px 15px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; }
    .btn-add { background:var(--p); }
    .btn-ocr { background:#5856D6; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:flex-end; z-index:1000; }
    .modal-content { background:#fff; width:100%; border-radius:25px 25px 0 0; padding:25px; box-sizing:border-box; max-height:82vh; overflow-y:auto; }
    input, select { width:100%; padding:15px; margin:10px 0; border:1px solid #ddd; border-radius:12px; font-size:18px; box-sizing:border-box; background:#f9f9f9; }
    .btn-submit { background:var(--p); color:#fff; width:100%; padding:18px; border-radius:15px; border:none; font-size:18px; font-weight:900; margin-top:10px; }
    .btn-ghost { background:#eee; color:#333; }

    .batch-item { display:flex; align-items:flex-start; gap:10px; border-bottom:1px solid #eee; padding:10px 0; }
    .batch-info { flex:1; font-size:14px; line-height:1.35; }
    .loading-spin { text-align:center; padding:30px; color:var(--p); }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#f2f2f7; color:#555; margin-left:8px; }

    /* ===== æŠ•èµ„è®¡åˆ’é¢æ¿ UI ===== */
    #plan-board { padding:12px 15px 0; }
    .plan-card { background:#fff; border-radius:15px; padding:16px; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin:0 0 12px 0; }
    .plan-title { font-size:16px; font-weight:900; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .plan-sub { font-size:12px; color:#888; margin-top:6px; line-height:1.4; }
    .bar { height:10px; background:#eee; border-radius:999px; overflow:hidden; margin-top:10px; }
    .bar > div { height:100%; width:0%; background:var(--p); }
    .plan-row { display:flex; justify-content:space-between; gap:10px; margin-top:12px; align-items:flex-end; }
    .plan-sym { font-weight:900; }
    .plan-meta { font-size:12px; color:#666; }
    .badge { font-size:12px; padding:2px 8px; border-radius:999px; background:#f2f2f7; color:#555; white-space:nowrap; }
    .badge.over { background:#ffecec; color:#c00; }
  </style>
</head>

<body>
<header>
  <div class="header-grid">
    <div>
      <div class="stat-label">å®ç°æ€»ç›ˆäº (USD)</div>
      <div class="stat-val" id="total-pnl">$0.00</div>
    </div>
    <div style="text-align:right">
      <div class="stat-label">è®°å½•ç¬”æ•°</div>
      <div class="stat-val muted" id="total-count">0</div>
    </div>
  </div>
</header>

<section id="plan-board"></section>

<main id="trade-list"></main>

<div class="bottom-nav">
  <button class="btn-round btn-ocr" onclick="document.getElementById('file-input').click()">ğŸ“·</button>
  <button class="btn-round btn-add" onclick="showModal('manual')">+</button>
</div>

<input type="file" id="file-input" hidden accept="image/*" onchange="handleOcr(this)" />

<div class="modal" id="modal-manual" onclick="if(event.target==this)this.style.display='none'">
  <div class="modal-content">
    <h2 style="margin-top:0">æ–°äº¤æ˜“å½•å…¥</h2>
    <input type="text" id="m-symbol" placeholder="è‚¡ç¥¨ä»£ç  (å¦‚ NVDA / VOO / CASH)" style="text-transform:uppercase" />
    <select id="m-action">
      <option value="buy">ä¹°å…¥ / åŠ ä»“</option>
      <option value="sell">å–å‡º / å‡ä»“ï¼ˆæœªæ¥ç”¨ï¼‰</option>
    </select>
    <div style="display:flex; gap:10px;">
      <input type="number" id="m-qty" inputmode="decimal" placeholder="æ•°é‡" />
      <input type="number" id="m-price" inputmode="decimal" placeholder="æˆäº¤ä»·ï¼ˆCASH å¯å¡« 1ï¼‰" />
    </div>
    <input type="number" id="m-fee" inputmode="decimal" placeholder="æ‰‹ç»­è´¹ (å¯é€‰)" value="0" />
    <button class="btn-submit" onclick="saveManual()">ä¿å­˜è®°å½•</button>
  </div>
</div>

<div class="modal" id="modal-ocr">
  <div class="modal-content">
    <h2 style="margin-top:0">è¯†åˆ«ç»“æœç¡®è®¤ <span class="pill">IBKR ä¹°å…¥å†å² / æ‰¹æ¬¡</span></h2>
    <div id="ocr-status"></div>
    <div id="ocr-results"></div>
    <button class="btn-submit" id="btn-import-all" style="display:none;" onclick="importBatch()">ç¡®è®¤å¯¼å…¥é€‰ä¸­é¡¹</button>
    <button class="btn-submit btn-ghost" onclick="closeOcrModal()">å–æ¶ˆ</button>
  </div>
</div>

<script>
  // ========= 1) æ•°æ®åº“ =========
  const db = new Dexie("TradeLedgerDB");
  db.version(1).stores({ trades: "++id, symbol, action, timestamp" });

  let ocrTempData = [];

  // ========= 2) æŠ•èµ„è®¡åˆ’ï¼ˆé»˜è®¤æŒ‰ä½ æˆªå›¾ï¼‰ =========
  // å£å¾„ï¼šç›®æ ‡é‡‘é¢ï¼ˆUSDï¼‰
  const PLAN = {
    title: "20ä¸‡äººæ°‘å¸é•¿æœŸæŠ•èµ„é…ç½®ï¼ˆæ‰§è¡Œç‰ˆï¼‰",
    totalTargetUsd: 28000,
    targets: {
      VOO: 5600,
      QQQ: 4200,
      SMH: 4200,

      COPX: 2800,
      URNM: 2800,
      CCJ: 1960,
      LTBR: 840,

      VWO: 1960,
      VNM: 840,
      EWJ: 1120,

      CASH: 1680,   // ç°é‡‘/æœºåŠ¨ï¼ˆå»ºè®®æ‰‹åŠ¨å½•ä¸€æ¡ CASH ä¹°å…¥ï¼šqty=å…¥é‡‘ç¾å…ƒ, price=1ï¼‰
      NVDA: 1400,
      TSLA: 840,
      OTHER: 560
    }
  };

  function startOfLocalDay(ts) {
    const d = new Date(ts);
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function renderPlanBoard({ investedTotal, todayAdded, remainingTotal, perSymbol }) {
    const el = document.getElementById("plan-board");
    const pct = PLAN.totalTargetUsd > 0 ? Math.min(100, (investedTotal / PLAN.totalTargetUsd) * 100) : 0;

    const rows = Object.entries(PLAN.targets).map(([sym, target]) => {
      const invested = perSymbol[sym] || 0;
      const remaining = target - invested;
      const p = target > 0 ? Math.min(100, (invested / target) * 100) : 0;
      const over = remaining < -0.01;

      return `
        <div class="plan-row">
          <div>
            <div class="plan-sym">${sym}</div>
            <div class="plan-meta">ç›®æ ‡ $${target.toFixed(0)} Â· å·²æŠ• $${invested.toFixed(0)}</div>
          </div>
          <div style="text-align:right">
            <div class="badge ${over ? "over" : ""}">
              ${over ? `è¶…é… $${Math.abs(remaining).toFixed(0)}` : `è¿˜å·® $${Math.max(0, remaining).toFixed(0)}`}
            </div>
            <div class="plan-meta" style="margin-top:6px;">è¿›åº¦ ${p.toFixed(0)}%</div>
          </div>
        </div>
        <div class="bar"><div style="width:${p.toFixed(2)}%"></div></div>
      `;
    }).join("");

    el.innerHTML = `
      <div class="plan-card">
        <div class="plan-title">
          <span>${PLAN.title}</span>
          <span class="badge">ä»Šæ—¥ +$${todayAdded.toFixed(2)}</span>
        </div>

        <div class="plan-sub">
          æ€»ç›®æ ‡ $${PLAN.totalTargetUsd.toFixed(0)} Â· å·²æŠ• $${investedTotal.toFixed(2)} Â· è·ç¦»ç›®æ ‡ $${Math.max(0, remainingTotal).toFixed(2)}
        </div>

        <div class="bar"><div style="width:${pct.toFixed(2)}%"></div></div>

        <div style="margin-top:14px;">
          ${rows}
        </div>

        <div class="plan-sub" style="margin-top:12px;">
          å£å¾„ï¼šå·²æŠ•=ä¹°å…¥é‡‘é¢åˆè®¡ï¼ˆqtyÃ—price+feeï¼‰ï¼Œä¸å«å¸‚å€¼æ³¢åŠ¨ï¼›CASH/OTHER ä¸å½•å…¥äº¤æ˜“ä¼šä¸€ç›´æ˜¾ç¤ºâ€œè¿˜å·®â€ã€‚
        </div>
      </div>
    `;
  }

  // ========= 3) æ ¸å¿ƒé€»è¾‘ï¼šå‡ä»·ä¸ç›ˆäºï¼ˆä½ æœªæ¥å–å‡ºä¹Ÿä¸ç‚¸ï¼‰ =========
  async function calculateAndRender() {
    const allTrades = await db.trades.orderBy("timestamp").toArray();
    const listEl = document.getElementById("trade-list");

    // ---- A) è®¡åˆ’ç»Ÿè®¡ï¼šå·²æŠ•/ä»Šæ—¥åŠ ä»“/å‰©ä½™ ----
    const today0 = startOfLocalDay(Date.now());
    let investedTotal = 0;
    let todayAdded = 0;
    let perSymbol = {}; // buy é‡‘é¢ç´¯è®¡

    for (const t of allTrades) {
      if (t.action !== "buy") continue;
      const amt = (t.qty * t.price) + (t.fee || 0);
      investedTotal += amt;

      const sym = (t.symbol || "").toUpperCase();
      perSymbol[sym] = (perSymbol[sym] || 0) + amt;

      if (t.timestamp >= today0) todayAdded += amt;
    }

    const remainingTotal = PLAN.totalTargetUsd - investedTotal;
    renderPlanBoard({ investedTotal, todayAdded, remainingTotal, perSymbol });

    // ---- B) è´¦æœ¬ç›ˆäºï¼ˆç°åœ¨æ²¡å–=0ï¼Œæœªæ¥å–äº†ä¼šç®—ï¼‰----
    let inventory = {}; // { NVDA: { qty, cost } }
    let totalPnL = 0;

    const processed = allTrades.map(t => {
      const sym = (t.symbol || "").toUpperCase();
      if (!inventory[sym]) inventory[sym] = { qty: 0, cost: 0 };

      let pnl = null;
      let pnlRate = null;

      if (t.action === "buy") {
        inventory[sym].qty += t.qty;
        inventory[sym].cost += (t.qty * t.price + (t.fee || 0));
      } else {
        if (inventory[sym].qty <= 0) {
          pnl = null; // æ²¡ä»“ä½å°±ä¸ç®—ï¼ˆé¿å… NaNï¼‰
        } else {
          const avgPrice = inventory[sym].cost / inventory[sym].qty;
          pnl = (t.price - avgPrice) * t.qty - (t.fee || 0);
          pnlRate = ((pnl / (avgPrice * t.qty)) * 100).toFixed(2);
          totalPnL += pnl;

          inventory[sym].cost -= (avgPrice * t.qty);
          inventory[sym].qty -= t.qty;

          if (inventory[sym].qty < 1e-9) {
            inventory[sym].qty = 0;
            inventory[sym].cost = 0;
          }
        }
      }

      const curQty = inventory[sym].qty;
      const curAvg = curQty > 0 ? (inventory[sym].cost / curQty) : 0;

      return {
        ...t,
        symbol: sym,
        pnl,
        pnlRate,
        currentAvg: curAvg.toFixed(2),
      };
    });

    document.getElementById("total-pnl").innerText = `$${totalPnL.toFixed(2)}`;
    document.getElementById("total-pnl").className = "stat-val " + (totalPnL >= 0 ? "win" : "loss");
    document.getElementById("total-count").innerText = allTrades.length;

    listEl.innerHTML = processed.reverse().map(t => `
      <div class="card ${t.action}">
        <div class="card-row">
          <span class="symbol">${t.symbol}</span>
          <span class="time">${new Date(t.timestamp).toLocaleString()}</span>
        </div>
        <div class="card-row">
          <span>${t.action === "buy" ? "ä¹°å…¥" : "å–å‡º"} ${t.qty} è‚¡</span>
          <span style="font-weight:900">$${Number(t.price).toFixed(2)}</span>
        </div>

        ${
          (t.action === "buy" && typeof t.unrealizedPnl === "number")
          ? `<div class="card-row subtle" style="margin-top:6px;">
              <span>æ‰¹æ¬¡æµ®ç›ˆäº(æˆªå›¾)</span>
              <span class="${t.unrealizedPnl >= 0 ? "win" : "loss"}" style="font-weight:900;">
                ${t.unrealizedPnl >= 0 ? "+" : ""}$${t.unrealizedPnl.toFixed(2)}
              </span>
            </div>`
          : ""
        }

        ${
          t.pnl !== null
          ? `<div class="pnl-box">
              <span class="${t.pnl >= 0 ? "win" : "loss"}" style="font-weight:900">
                ç›ˆäº: $${t.pnl.toFixed(2)} (${t.pnlRate}%)
              </span>
            </div>`
          : `<div style="text-align:right; font-size:12px; color:#999">å½“å‰å‡ä»·: $${t.currentAvg}</div>`
        }
      </div>
    `).join("");
  }

  // ========= 4) OCR Worker å¤ç”¨ =========
  let ocrWorkerPromise = null;

  async function getOcrWorker() {
    if (!ocrWorkerPromise) {
      ocrWorkerPromise = (async () => {
        const worker = await Tesseract.createWorker("eng");
        await worker.setParameters({
          tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789$.,:+-/%() ",
        });
        return worker;
      })();
    }
    return ocrWorkerPromise;
  }

  // ========= 5) å›¾ç‰‡é¢„å¤„ç†ï¼ˆæ”¾å¤§Ã—2 + å¯è£å‰ªï¼‰ =========
  // å¦‚æœä½ å‘ç°æœ‰äº›æˆªå›¾è£å‰ªæ‰äº†è¡¨æ ¼ï¼ŒæŠŠ ENABLE_CROP æ”¹ä¸º false
  const ENABLE_CROP = true;
  const CROP = { left: 0.04, top: 0.12, width: 0.92, height: 0.60 };

  async function preprocessImageToBlob(file) {
    const img = await loadImageFromFile(file);

    const sx = ENABLE_CROP ? Math.floor(img.width * CROP.left) : 0;
    const sy = ENABLE_CROP ? Math.floor(img.height * CROP.top) : 0;
    const sw = ENABLE_CROP ? Math.floor(img.width * CROP.width) : img.width;
    const sh = ENABLE_CROP ? Math.floor(img.height * CROP.height) : img.height;

    const scale = 2;
    const canvas = document.createElement("canvas");
    canvas.width = sw * scale;
    canvas.height = sh * scale;

    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

    return await new Promise(resolve => canvas.toBlob(resolve, "image/png", 1.0));
  }

  function loadImageFromFile(file) {
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
      img.onerror = e => { URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  // ========= 6) OCR è§£æï¼šé’ˆå¯¹â€œæŸ¥çœ‹æ‰¹æ¬¡ / ä¹°å…¥å†å²â€ =========
  function parseLotsFromOcr(data) {
    const fullText = (data.text || "").replace(/\s+/g, " ").trim();
    const lines = (data.lines || []).map(l => (l.text || "").trim()).filter(Boolean);

    // æå– symbolï¼ˆNVDA NASDAQ / æˆ–é€€åŒ–ä¸ºä»»æ„ tickerï¼‰
    let symbol = null;
    const m1 = fullText.match(/\b([A-Z]{1,5}(?:\.[A-Z])?)\b(?=\s+(NASDAQ|NYSE|ARCA|BATS)\b)/);
    const m2 = fullText.match(/\b([A-Z]{1,5}(?:\.[A-Z])?)\b/);
    symbol = (m1 && m1[1]) || (m2 && m2[1]) || null;
    if (symbol) symbol = symbol.toUpperCase();

    const moneyToNumber = s => parseFloat(String(s).replace(/[^0-9.+-]/g, ""));
    const results = [];

    for (const text of lines) {
      const mDate = text.match(/\b(20\d{2}-\d{2}-\d{2})\b/);
      if (!mDate) continue;

      const moneyMatches = text.match(/\$[0-9,]+(?:\.\d+)?/g) || [];
      if (moneyMatches.length < 1) continue;

      const acquiredDate = mDate[1];
      const avgPrice = moneyToNumber(moneyMatches[0]);

      const idxMoney = text.indexOf(moneyMatches[0]);
      const after = idxMoney >= 0 ? text.slice(idxMoney + moneyMatches[0].length) : text;

      // qtyï¼šå–ç¬¬ä¸€ä¸ªåˆç†æ•°å­—
      const mQty = after.match(/\b(\d+(?:\.\d+)?)\b/);
      const qty = mQty ? parseFloat(mQty[1]) : null;

      // åˆè®¡ç›ˆäºï¼ˆå¯é€‰ï¼‰ï¼šè¡Œé‡Œæœ‰ç¬¬äºŒä¸ª$ä¸€èˆ¬æ˜¯ P&L
      let pnl = null;
      if (moneyMatches.length >= 2) pnl = moneyToNumber(moneyMatches[moneyMatches.length - 1]);

      if (!symbol || !Number.isFinite(avgPrice) || !Number.isFinite(qty) || qty <= 0) continue;

      results.push({
        symbol,
        action: "buy",
        qty,
        price: avgPrice,
        fee: 0,
        timestamp: new Date(acquiredDate + "T00:00:00").getTime(),
        acquiredDate,
        unrealizedPnl: Number.isFinite(pnl) ? pnl : undefined,
        source: "ibkr_lots_ocr",
      });
    }

    // å»é‡
    const seen = new Set();
    const deduped = [];
    for (const r of results) {
      const key = `${r.symbol}|${r.acquiredDate}|${r.qty}|${r.price}`;
      if (!seen.has(key)) {
        seen.add(key);
        deduped.push(r);
      }
    }
    return deduped;
  }

  // ========= 7) OCR ä¸»æµç¨‹ =========
  async function handleOcr(input) {
    const file = input.files && input.files[0];
    if (!file) return;

    openOcrModal();
    const status = document.getElementById("ocr-status");
    const resultsEl = document.getElementById("ocr-results");
    const btn = document.getElementById("btn-import-all");

    status.innerHTML = '<div class="loading-spin">æ­£åœ¨è§£ææˆªå›¾ï¼ˆå»ºè®®æˆªå›¾åŒ…å«â€œä¹°å…¥å†å²â€è¡¨æ ¼ï¼‰...</div>';
    resultsEl.innerHTML = "";
    btn.style.display = "none";

    try {
      const worker = await getOcrWorker();
      const blob = await preprocessImageToBlob(file);
      const { data } = await worker.recognize(blob);

      ocrTempData = parseLotsFromOcr(data);

      if (ocrTempData.length > 0) {
        status.innerHTML = `è¯†åˆ«åˆ° <b>${ocrTempData.length}</b> æ¡ä¹°å…¥æ‰¹æ¬¡ï¼š`;
        resultsEl.innerHTML = ocrTempData.map((d, i) => `
          <div class="batch-item">
            <input type="checkbox" checked id="chk-${i}" style="width:20px; height:20px; margin-top:2px;">
            <div class="batch-info">
              <div><b>${d.symbol}</b> ${d.qty} è‚¡ @ $${Number(d.price).toFixed(2)}</div>
              <div class="subtle">è·å¾—æ—¥æœŸï¼š${d.acquiredDate || new Date(d.timestamp).toLocaleDateString()}</div>
              ${
                typeof d.unrealizedPnl === "number"
                ? `<div class="${d.unrealizedPnl >= 0 ? "win" : "loss"}" style="font-weight:900;">
                     åˆè®¡ç›ˆäº(æˆªå›¾)ï¼š${d.unrealizedPnl >= 0 ? "+" : ""}$${d.unrealizedPnl.toFixed(2)}
                   </div>`
                : ""
              }
            </div>
          </div>
        `).join("");
        btn.style.display = "block";
      } else {
        status.innerHTML = "æœªè¯†åˆ«å‡ºæœ‰æ•ˆæ‰¹æ¬¡æ•°æ®ã€‚<br><span class='subtle'>å»ºè®®ï¼šæˆªå›¾å°½é‡åªåŒ…å«â€œä¹°å…¥å†å²â€è¡¨æ ¼ï¼›æˆ–æŠŠ ENABLE_CROP è®¾ä¸º falseã€‚</span>";
      }
    } catch (e) {
      status.innerHTML = "è¯†åˆ«å¤±è´¥ï¼š" + (e && e.message ? e.message : String(e));
    } finally {
      input.value = ""; // å…è®¸è¿ç»­é€‰åŒä¸€å¼ å›¾ä¹Ÿè§¦å‘ onchange
    }
  }

  async function importBatch() {
    for (let i = 0; i < ocrTempData.length; i++) {
      const chk = document.getElementById(`chk-${i}`);
      if (chk && chk.checked) {
        await db.trades.add({
          symbol: ocrTempData[i].symbol,
          action: "buy",
          qty: ocrTempData[i].qty,
          price: ocrTempData[i].price,
          fee: 0,
          timestamp: ocrTempData[i].timestamp,
          acquiredDate: ocrTempData[i].acquiredDate,
          unrealizedPnl: ocrTempData[i].unrealizedPnl,
          source: ocrTempData[i].source
        });
      }
    }
    closeOcrModal();
    calculateAndRender();
  }

  function openOcrModal() { document.getElementById("modal-ocr").style.display = "flex"; }
  function closeOcrModal() { document.getElementById("modal-ocr").style.display = "none"; }

  // ========= 8) æ‰‹åŠ¨å½•å…¥ =========
  function showModal(id) { document.getElementById("modal-" + id).style.display = "flex"; }

  async function saveManual() {
    const symbol = document.getElementById("m-symbol").value.trim().toUpperCase();
    const action = document.getElementById("m-action").value;
    const qty = parseFloat(document.getElementById("m-qty").value);
    const price = parseFloat(document.getElementById("m-price").value);
    const fee = parseFloat(document.getElementById("m-fee").value || 0);

    if (!symbol || !Number.isFinite(qty) || qty <= 0 || !Number.isFinite(price) || price <= 0) {
      return alert("ä¿¡æ¯ä¸å…¨æˆ–ä¸åˆæ³•ï¼ˆsymbol/æ•°é‡/ä»·æ ¼ï¼‰");
    }

    await db.trades.add({
      symbol,
      action,
      qty,
      price,
      fee: Number.isFinite(fee) ? fee : 0,
      timestamp: Date.now(),
      source: "manual"
    });

    document.getElementById("modal-manual").style.display = "none";
    calculateAndRender();
  }

  // åˆå§‹æ¸²æŸ“
  calculateAndRender();
</script>
</body>
</html>