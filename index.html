<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾è‚¡æ“ç›˜è´¦æœ¬</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2422/2422796.png">
    
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

    <style>
        :root { --p: #007AFF; --s: #34C759; --d: #FF3B30; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; -webkit-user-select: none; }
        
        /* é¡¶éƒ¨çœ‹æ¿ */
        header { background: #fff; padding: 25px 20px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .stat-val { font-size: 22px; font-weight: bold; }
        .win { color: var(--s); }
        .loss { color: var(--d); }

        /* åˆ—è¡¨å¡ç‰‡ */
        main { padding: 15px; }
        .card { background: #fff; border-radius: 15px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 6px solid #ccc; }
        .card.buy { border-left-color: var(--p); }
        .card.sell { border-left-color: #FF9500; }
        .card-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .symbol { font-size: 18px; font-weight: 800; }
        .time { font-size: 12px; color: #999; }
        .pnl-box { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; text-align: right; }

        /* åº•éƒ¨æ“ä½œåŒº */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 100; }
        .btn-round { width: 65px; height: 65px; border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        .btn-add { background: var(--p); }
        .btn-ocr { background: #5856D6; }

        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: flex-end; z-index: 1000; }
        .modal-content { background: #fff; width: 100%; border-radius: 25px 25px 0 0; padding: 25px; box-sizing: border-box; max-height: 80vh; overflow-y: auto; }
        input, select { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 18px; box-sizing: border-box; background: #f9f9f9; }
        .btn-submit { background: var(--p); color: white; width: 100%; padding: 18px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; margin-top: 10px; }
        
        /* æ‰¹é‡å¯¼å…¥åˆ—è¡¨ */
        .batch-item { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; padding: 10px 0; }
        .batch-info { flex: 1; font-size: 14px; }
        .loading-spin { text-align: center; padding: 30px; color: var(--p); }
    </style>
</head>
<body>

<header>
    <div>
        <div class="stat-label">å®ç°æ€»ç›ˆäº (USD)</div>
        <div class="stat-val" id="total-pnl">$0.00</div>
    </div>
    <div style="text-align: right">
        <div class="stat-label">æˆäº¤ç¬”æ•°</div>
        <div class="stat-val" id="total-count">0</div>
    </div>
</header>

<main id="trade-list"></main>

<div class="bottom-nav">
    <button class="btn-round btn-ocr" onclick="document.getElementById('file-input').click()">ğŸ“·</button>
    <button class="btn-round btn-add" onclick="showModal('manual')">+</button>
</div>

<input type="file" id="file-input" hidden accept="image/*" onchange="handleOcr(this)">

<div class="modal" id="modal-manual" onclick="if(event.target==this)this.style.display='none'">
    <div class="modal-content">
        <h2 style="margin-top:0">æ–°äº¤æ˜“å½•å…¥</h2>
        <input type="text" id="m-symbol" placeholder="è‚¡ç¥¨ä»£ç  (å¦‚ NVDA)" style="text-transform:uppercase">
        <select id="m-action">
            <option value="buy">ä¹°å…¥ / åŠ ä»“</option>
            <option value="sell">å–å‡º / å‡ä»“</option>
        </select>
        <div style="display:flex; gap:10px;">
            <input type="number" id="m-qty" inputmode="decimal" placeholder="æ•°é‡">
            <input type="number" id="m-price" inputmode="decimal" placeholder="æˆäº¤ä»·">
        </div>
        <input type="number" id="m-fee" inputmode="decimal" placeholder="æ‰‹ç»­è´¹ (å¯é€‰)" value="0">
        <button class="btn-submit" onclick="saveManual()">ä¿å­˜è®°å½•</button>
    </div>
</div>

<div class="modal" id="modal-ocr">
    <div class="modal-content">
        <h2 style="margin-top:0">è¯†åˆ«ç»“æœç¡®è®¤</h2>
        <div id="ocr-status"></div>
        <div id="ocr-results"></div>
        <button class="btn-submit" id="btn-import-all" style="display:none;" onclick="importBatch()">ç¡®è®¤å¯¼å…¥é€‰ä¸­é¡¹</button>
        <button class="btn-submit" style="background:#eee; color:#333;" onclick="document.getElementById('modal-ocr').style.display='none'">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // --- 1. æ•°æ®åº“é…ç½® ---
    const db = new Dexie("TradeLedgerDB");
    db.version(1).stores({ trades: '++id, symbol, action, timestamp' });

    let ocrTempData = [];

    // --- 2. æ ¸å¿ƒé€»è¾‘ï¼šå‡ä»·ä¸ç›ˆäºè®¡ç®— ---
    async function calculateAndRender() {
        const allTrades = await db.trades.orderBy('timestamp').toArray();
        const listEl = document.getElementById('trade-list');
        
        let inventory = {}; // ç»“æ„: { AAPL: { totalQty: 0, totalCost: 0 } }
        let totalPnL = 0;

        const processed = allTrades.map(t => {
            if (!inventory[t.symbol]) inventory[t.symbol] = { qty: 0, cost: 0 };
            let pnl = null;
            let pnlRate = null;

            if (t.action === 'buy') {
                inventory[t.symbol].qty += t.qty;
                inventory[t.symbol].cost += (t.qty * t.price + t.fee);
            } else {
                // å–å‡ºï¼šåŸºäºå½“å‰å‡ä»·ç®—ç›ˆäº
                const avgPrice = inventory[t.symbol].cost / inventory[t.symbol].qty;
                pnl = (t.price - avgPrice) * t.qty - t.fee;
                pnlRate = ((pnl / (avgPrice * t.qty)) * 100).toFixed(2);
                totalPnL += pnl;
                
                // æ›´æ–°åº“å­˜ï¼ˆæŒ‰æ¯”ä¾‹å‡å°‘æˆæœ¬ï¼‰
                inventory[t.symbol].cost -= (avgPrice * t.qty);
                inventory[t.symbol].qty -= t.qty;
            }
            return { ...t, pnl, pnlRate, currentAvg: (inventory[t.symbol].cost / inventory[t.symbol].qty).toFixed(2) };
        });

        // æ›´æ–° UI
        document.getElementById('total-pnl').innerText = `$${totalPnL.toFixed(2)}`;
        document.getElementById('total-pnl').className = 'stat-val ' + (totalPnL >= 0 ? 'win' : 'loss');
        document.getElementById('total-count').innerText = allTrades.length;

        listEl.innerHTML = processed.reverse().map(t => `
            <div class="card ${t.action}">
                <div class="card-row">
                    <span class="symbol">${t.symbol}</span>
                    <span class="time">${new Date(t.timestamp).toLocaleString()}</span>
                </div>
                <div class="card-row">
                    <span>${t.action==='buy'?'ä¹°å…¥':'å–å‡º'} ${t.qty} è‚¡</span>
                    <span style="font-weight:bold">$${t.price}</span>
                </div>
                ${t.pnl !== null ? `
                    <div class="pnl-box">
                        <span class="${t.pnl >= 0 ? 'win' : 'loss'}" style="font-weight:bold">
                            ç›ˆäº: $${t.pnl.toFixed(2)} (${t.pnlRate}%)
                        </span>
                    </div>
                ` : `<div style="text-align:right; font-size:12px; color:#999">å½“å‰å‡ä»·: $${t.currentAvg}</div>`}
            </div>
        `).join('');
    }

    // --- 3. OCR è¯†åˆ«é€»è¾‘ ---
    async function handleOcr(input) {
        if (!input.files[0]) return;
        document.getElementById('modal-ocr').style.display = 'flex';
        const status = document.getElementById('ocr-status');
        const results = document.getElementById('ocr-results');
        status.innerHTML = '<div class="loading-spin">æ·±åº¦è§£æå›¾ä¸­ï¼Œè¯·ç¨å...</div>';
        results.innerHTML = '';
        
        try {
            const worker = await Tesseract.createWorker('eng');
            const { data } = await worker.recognize(input.files[0]);
            await worker.terminate();

            // IBKR è¯†åˆ«ç®—æ³•ï¼šå¯»æ‰¾å¤§å†™å­—æ¯å¼€å¤´çš„è¡Œï¼Œæå–å…¶åçš„æ•°å­—
            const lines = data.lines;
            ocrTempData = [];

            lines.forEach(line => {
                const text = line.text.trim();
                // åŒ¹é…è§„åˆ™ï¼š[ä»£ç ] [ç©ºæ ¼/å­—ç¬¦] [ä»·æ ¼æ•°å­—] ... [æŒä»“æ•°å­—]
                const symbolMatch = text.match(/^([A-Z]{2,5})\b/);
                if (symbolMatch) {
                    const numbers = text.match(/(\d+\.\d{2,})/g); // æ‰¾å¸¦å°æ•°çš„æ•°å­—
                    if (numbers && numbers.length >= 2) {
                        ocrTempData.push({
                            symbol: symbolMatch[1],
                            price: parseFloat(numbers[0]),
                            qty: parseFloat(numbers[numbers.length - 1]), // æœ€åä¸€ä¸ªæ•°å­—é€šå¸¸æ˜¯æŒä»“é‡
                            action: 'buy'
                        });
                    }
                }
            });

            if (ocrTempData.length > 0) {
                status.innerHTML = `è¯†åˆ«åˆ° ${ocrTempData.length} æ¡æŒä»“æ•°æ®ï¼š`;
                results.innerHTML = ocrTempData.map((d, i) => `
                    <div class="batch-item">
                        <input type="checkbox" checked id="chk-${i}" style="width:20px; height:20px;">
                        <div class="batch-info">
                            <b>${d.symbol}</b> - ${d.qty}è‚¡ @ $${d.price}
                        </div>
                    </div>
                `).join('');
                document.getElementById('btn-import-all').style.display = 'block';
            } else {
                status.innerHTML = 'æœªèƒ½è¯†åˆ«å‡ºæœ‰æ•ˆæ•°æ®ï¼Œè¯·ç¡®ä¿æˆªå›¾æ¸…æ™°ä¸”åŒ…å«æŒä»“è¡¨æ ¼ã€‚';
            }
        } catch (e) {
            status.innerHTML = 'è¯†åˆ«å¤±è´¥ï¼š' + e.message;
        }
    }

    async function importBatch() {
        for(let i=0; i<ocrTempData.length; i++) {
            if(document.getElementById(`chk-${i}`).checked) {
                await db.trades.add({
                    ...ocrTempData[i],
                    fee: 0,
                    timestamp: Date.now() + i
                });
            }
        }
        document.getElementById('modal-ocr').style.display = 'none';
        calculateAndRender();
    }

    // --- 4. åŸºç¡€äº¤äº’ ---
    function showModal(id) { document.getElementById('modal-'+id).style.display = 'flex'; }

    async function saveManual() {
        const data = {
            symbol: document.getElementById('m-symbol').value.toUpperCase(),
            action: document.getElementById('m-action').value,
            qty: parseFloat(document.getElementById('m-qty').value),
            price: parseFloat(document.getElementById('m-price').value),
            fee: parseFloat(document.getElementById('m-fee').value || 0),
            timestamp: Date.now()
        };
        if(!data.symbol || !data.qty) return alert('ä¿¡æ¯ä¸å…¨');
        await db.trades.add(data);
        document.getElementById('modal-manual').style.display = 'none';
        calculateAndRender();
    }

    calculateAndRender();
</script>
</body>
</html>