<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾è‚¡æ™ºèƒ½è´¦æœ¬</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        :root { --p: #2563eb; --s: #16a34a; --d: #dc2626; --bg: #f1f5f9; }
        body { font-family: system-ui; background: var(--bg); margin: 0; padding-bottom: 80px; }
        header { background: #fff; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; display: block; }
        
        main { padding: 15px; }
        .trade-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #ccc; }
        .item-buy { border-left-color: var(--s); }
        .item-sell { border-left-color: var(--p); }
        
        /* åº•éƒ¨æ“ä½œæ  */
        .bottom-bar { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; padding: 10px 0; border-top: 1px solid #ddd; }
        .btn-main { flex: 1; margin: 0 10px; padding: 12px; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; }
        .btn-add { background: var(--p); color: white; }
        .btn-ocr { background: #64748b; color: white; }

        /* å¼¹çª—æ ·å¼ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: flex-end; z-index: 100; }
        .modal-content { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .ocr-loading { display: none; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<header>
    <div class="summary">
        <div class="stat-card">
            <span style="color: #64748b; font-size: 12px;">æ€»å®ç°ç›ˆäº</span>
            <span class="stat-val" id="total-pnl">$0.00</span>
        </div>
        <div class="stat-card">
            <span style="color: #64748b; font-size: 12px;">å½“å‰æŒä»“æ•°</span>
            <span class="stat-val" id="pos-count">0</span>
        </div>
    </div>
</header>

<main id="list-container"></main>

<div class="bottom-bar">
    <button class="btn-main btn-ocr" onclick="document.getElementById('file-input').click()">ğŸ“· æˆªå›¾è¯†åˆ«</button>
    <button class="btn-main btn-add" onclick="openModal()">+ æ‰‹åŠ¨è®°è´¦</button>
</div>

<input type="file" id="file-input" hidden accept="image/*" onchange="handleOCR(this)">

<div class="modal" id="modal">
    <div class="modal-content">
        <h3 id="modal-title">è®°ä¸€ç¬”äº¤æ˜“</h3>
        <div id="ocr-status" class="ocr-loading">æ­£åœ¨è¯†åˆ«å›¾ç‰‡ï¼Œè¯·ç¨å...</div>
        <input type="text" id="symbol" placeholder="è‚¡ç¥¨ä»£ç  (å¦‚ AAPL)" required>
        <select id="action">
            <option value="buy">ä¹°å…¥ / åŠ ä»“</option>
            <option value="sell">å–å‡º / å‡ä»“</option>
        </select>
        <input type="number" id="qty" inputmode="decimal" placeholder="æˆäº¤æ•°é‡">
        <input type="number" id="price" inputmode="decimal" placeholder="æˆäº¤å•ä»·">
        <input type="number" id="fee" inputmode="decimal" placeholder="æ‰‹ç»­è´¹ (é»˜è®¤0)" value="0">
        <button class="btn-main btn-add" style="width:100%; margin: 10px 0;" onclick="saveData()">ä¿å­˜</button>
        <button class="btn-main" style="background:#eee;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const db = new Dexie("StockDB");
    db.version(1).stores({ trades: '++id, symbol, action, timestamp' });

    // --- æ ¸å¿ƒé€»è¾‘ï¼šè®¡ç®—å‡ä»·ä¸ç›ˆäº ---
    async function calculateMetrics() {
        const allTrades = await db.trades.orderBy('timestamp').toArray();
        let inventory = {}; // { AAPL: { qty: 0, totalCost: 0 } }
        let totalRealizedPnL = 0;

        const processedTrades = allTrades.map(t => {
            if (!inventory[t.symbol]) inventory[t.symbol] = { qty: 0, totalCost: 0 };
            
            let itemPnL = null;
            let itemPnLRate = null;

            if (t.action === 'buy') {
                inventory[t.symbol].qty += t.qty;
                inventory[t.symbol].totalCost += (t.qty * t.price + t.fee);
            } else {
                // å–å‡ºé€»è¾‘
                const avgPrice = inventory[t.symbol].totalCost / inventory[t.symbol].qty;
                itemPnL = (t.price - avgPrice) * t.qty - t.fee;
                itemPnLRate = ((itemPnL / (avgPrice * t.qty)) * 100).toFixed(2);
                
                totalRealizedPnL += itemPnL;
                
                // æ›´æ–°åº“å­˜
                inventory[t.symbol].qty -= t.qty;
                inventory[t.symbol].totalCost -= (avgPrice * t.qty);
            }

            return { ...t, realizedPnL: itemPnL, pnlRate: itemPnLRate, currentAvg: (inventory[t.symbol].totalCost / inventory[t.symbol].qty).toFixed(2) };
        });

        return { processedTrades, totalRealizedPnL, activePositions: Object.keys(inventory).filter(s => inventory[s].qty > 0).length };
    }

    // --- OCR è¯†åˆ«é€»è¾‘ ---
    async function handleOCR(input) {
        if (!input.files[0]) return;
        openModal();
        document.getElementById('ocr-status').style.display = 'block';
        
        try {
            const worker = await Tesseract.createWorker('eng');
            const { data: { text } } = await worker.recognize(input.files[0]);
            console.log("è¯†åˆ«ç»“æœ:", text);
            
            // ç®€å•çš„æ­£åˆ™åŒ¹é…ç¤ºä¾‹ï¼šå¯»æ‰¾è¿ç»­å¤§å†™å­—æ¯ä½œä¸ºä»£ç ï¼Œå¯»æ‰¾æ•°å­—ä½œä¸ºä»·æ ¼
            const symbolMatch = text.match(/[A-Z]{3,5}/);
            const priceMatch = text.match(/\d+\.\d{2}/);

            if (symbolMatch) document.getElementById('symbol').value = symbolMatch[0];
            if (priceMatch) document.getElementById('price').value = priceMatch[0];
            
            await worker.terminate();
        } catch (e) {
            alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥");
        } finally {
            document.getElementById('ocr-status').style.display = 'none';
        }
    }

    // --- UI æ“ä½œ ---
    function openModal() { document.getElementById('modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function saveData() {
        const data = {
            symbol: document.getElementById('symbol').value.toUpperCase(),
            action: document.getElementById('action').value,
            qty: parseFloat(document.getElementById('qty').value),
            price: parseFloat(document.getElementById('price').value),
            fee: parseFloat(document.getElementById('fee').value || 0),
            timestamp: Date.now(),
            date: new Date().toLocaleString()
        };
        await db.trades.add(data);
        closeModal();
        refresh();
    }

    async function refresh() {
        const { processedTrades, totalRealizedPnL, activePositions } = await calculateMetrics();
        
        document.getElementById('total-pnl').innerText = `$${totalRealizedPnL.toFixed(2)}`;
        document.getElementById('total-pnl').className = 'stat-val ' + (totalRealizedPnL >= 0 ? 'profit' : 'loss');
        document.getElementById('pos-count').innerText = activePositions;

        const container = document.getElementById('list-container');
        container.innerHTML = processedTrades.reverse().map(t => `
            <div class="trade-item ${t.action === 'buy' ? 'item-buy' : 'item-sell'}">
                <div style="display:flex; justify-content:space-between">
                    <strong>${t.symbol}</strong>
                    <span>${t.action === 'buy' ? 'åŠ ä»“' : 'å‡ä»“'}</span>
                </div>
                <div style="font-size:14px; color:#666; margin: 5px 0;">
                    ${t.qty}è‚¡ @ $${t.price} (è´¹: $${t.fee})
                </div>
                ${t.realizedPnL !== null ? `
                    <div style="text-align:right; font-weight:bold; color: ${t.realizedPnL >= 0 ? 'var(--s)' : 'var(--d)'}">
                        ç›ˆäº: $${t.realizedPnL.toFixed(2)} (${t.pnlRate}%)
                    </div>
                ` : `<div style="text-align:right; font-size:12px; color:#999">å½“å‰å‡ä»·: $${t.currentAvg}</div>`}
                <div style="font-size:10px; color:#999; margin-top:5px;">${t.date}</div>
            </div>
        `).join('');
    }

    refresh();
</script>
</body>
</html>